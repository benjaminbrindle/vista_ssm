# VISTA: Varying and Irregular Sampling Time-series Analysis

[![License](https://img.shields.io/badge/license-MIT-blue.svg)](https://github.com/benjaminbrindle/vista_ssm/blob/main/LICENSE)

We introduce VISTA, a Python tool based on the algorithm described in _VISTA-SSM: Varying and Irregular Sampling Time-series Analysis via State Space Models_.[^1] 

Real world time series data, particularly in the psychological sciences, is often characterized by irregular or ill-structured intervals. This challenge often emerges when exploring temporal data without clear prior categorical information about the subjects in a population. VISTA provides a new method for handling these sampling issues while performing unsupervised identification of groups (clustering) in such datasets.

We hope that VISTA will be an accessible and valuable tool for researchers to handle the challenges of healthcare and mental health data.

- [Installation](#installation)
- [Usage](#usage)
- [Example](#example)
- [More Examples](#more-examples)

## Approach
Our approach adapts linear Gaussian state space models (LGSSMs) to provide a flexible parametric framework for fitting a wide range of time series dynamics. The clustering approach itself is based on the assumption that the population can be represented as a mixture of a given number of LGSSMs[^2] . Each time series is assigned to a cluster with a unique set of parameters, and is assumed to have been generated by the dynamical system:

$$\dot x(t) = Ax(t) + w(t)$$$$y(t) = C x(t) + v(t)$$$$x(0) = \mu + u$$

where the observations are represented by $y(t)$, $x(t)$ is an unobserved latent variable, $u$, $v(t)$, and $w(t)$ are Gaussian noise, and $A$ and $C$ are matrices. 

![VISTA Schematic](https://github.com/benjaminbrindle/vista_ssm/blob/main/schematic.jpg)

The algorithmic structure of VISTA is sketched in the schematic above. For more technical details and derivations, see our paper[^1].  

## Installation 
```bash
git clone git@github.com:benjaminbrindle/vista_ssm.git
pip install -e vista_ssm
```

## Usage

We have compiled a number of useful helper functions to interface directly with the VISTA algorithm. For instance, one can run the VISTA algorithm by simply running the function:
```python
runVISTA(how,
         param_dic,
         dataset,
         time_points,
         **kwargs)
```
#### **`how`** 
Method for parameter initialization. Options:
   - `'random'` : Initialize parameters randomly within specified ranges
   - `'ident'` : Initialize parameters as identity matrices or near-identity
   - `'kmeans'` : Use k-means clustering on data to initialize parameters


#### **`param_dic`** 
Dictionary of model parameters:

   - `DIM_X` : Dimension of the latent state space
   - `DIM_Y` : Number of features/variables from data
   - `N_CLUSTER` : Number of clusters to identify
   - `NUM_CPU` : CPU cores used in parallel processing
   - `FIX` : Parameter to keep fixed during optimization.
        - Options: `['mu', 'P', 'A', 'Gamma', 'C', 'Sigma']`
        - Empty list means all parameters are optimized           
   - `NUM_LGSSM` : Number of LGSSMs per time series.
        - Only for kmeans initialization. 
        - (default used in our experiments: 30)
   - `MAX_ITER` : Maximum number of EM iterations before forced termination
        - (default used in our experiments: 500 or 1000)
   - `EPSILON` : Convergence threshold for parameter updates. Algorithm stops when absolute parameter changes < EPSILON
        - (default used in our experiments: 0.1)
   - `BIC` : Whether to output the Bayesian Information Criterion (`True` `False`)
            
#### **`dataset`**
Time series data with shape `(n_samples, n_time, dim_y, 1)`:
   - `n_samples`: Number of time series in dataset
   - `n_time`: Number of time points per series
   - `dim_y`: Dimension of observations
   - Last dimension must be 1

#### **`time_points`** 
Observation times for each time series `(n_samples, n_time)`
   - `n_samples`: Number of time series in dataset
   - `n_time`: Times for each observation in dataset

       
#### **`kwargs`**  
Optional arguments
   - `inits` : dictionary of lists of parameters to initialize the algorithm directly (skipping the **`how`** parameter)
        
   - `labels:` : ground truth labels to compare clustering performance to; if provided, prints confusion matrix

### Returns
**`dict`** 
Results dictionary containing:
   - `'parameter'` : Final fitted parameters of the mixture of LGSSMs
   - `'label'` : Cluster assignments of each time series


## Example

To try VISTA with a concrete example, run the following code:

```python
#===============================
# Import required libraries
#===============================
import numpy as np                                  # NumPy for numerical computations
from vista_ssm import vista_ssm_Funcs as vista      # VISTA-SSM
import matplotlib.pyplot as plt                     # Matplotlib for plotting
import matplotlib as mpl                            # Matplotlib base library
             

#===============================
# Generate example data
#===============================

# Define time points for each trajectory
tp=np.array([np.array([0,0.3,0.8]),      # 3 Time points for first trajectory
             np.array([0,0.1,0.3,1])],    # 4 Time points for second trajectory
             dtype=object)

# Define data values for each time point
data=np.array([np.array([[[0]],[[0.5]],[[0.8]]]),     # Values for first trajectory
               np.array([[[1]],[[.9]],[[.8]],[[0.7]]])], # Values for second trajectory
               dtype=object)   


#===============================
# Run VISTA algorithm
#===============================

# Define model parameters
param_dic={'DIM_X': 2,
           'DIM_Y': 1,
           'N_CLUSTER' : 2,
           'NUM_CPU' : 1,
           'FIX' : [],
           'MAX_ITER' : 1000,
           'EPSILON' : 0.1,
           'BIC' : True}

# Run VISTA with random parameter initialization
result=vista.runVISTA('random',param_dic,data,tp)


#===============================
# Visualize Results
#===============================

# Set high DPI for better quality figures
mpl.rcParams['figure.dpi']=600    

# Plot predicted clusters and observed data 
vista.predicted_trajectories(
    result['parameter'],    # Learned model parameters
    data,                   # Input data
    result['label'],        # Cluster assignments
    30,                     # Number of points to plot predicted trajectory from learned parameters
    plotcolor=(plt.cm.winter,0,0.8,0.3),  # Color scheme
    timepoints=tp           # Time points of input data
)
```
Which returns the number of iterations until the stopping tolerance was achieved and a plot of the data against the fitted LGSSMs.
![VISTA Example](https://github.com/benjaminbrindle/vista_ssm/blob/main/example.png)

## More Examples

The experiments folder contains several Jupyter notebooks showcasing VISTA and demonstrating its ease of use in practical settings. 

In the data folder we have collected the open-source datasets used in our panel[^3], epidemiological[^4], and ecological momentary assessment[^5] data examples for ease of reproducibility. We have compiled our results from running VISTA on each of these datasets in the results folder.

[^1]: [Brindle, B., Hull, T.D., Malgaroli, M.†, & Charon, N.† (2024) VISTA-SSM: Varying and Irregular Sampling Time-series Analysis via a State Space Model. arXiv preprint:](https://LINK)

[^2]: [Umatani, R., Imai, T., Kawamoto, K., & Kunimasa, S. (2023). Time series clustering with
an em algorithm for mixtures of linear gaussian state space models. Pattern
Recognition, 138, 109375.](https://github.com/ur17/em_mlgssm)

[^3]: [World Health Organization COVID-19 Dashboard](https://data.who.int/dashboards/covid19)

[^4]: [U.S. Census Bureau Historical Annual Time Series of State Population Estimates](https://web.archive.org/web/20040220002039/https://eire.census.gov/popest/archives/state/st_stts.php)

[^5]: [Fried, E. I., Papanikolaou, F., & Epskamp, S. (2022). Mental health and social contact
during the covid-19 pandemic: An ecological momentary assessment study. Clinical
Psychological Science, 10 (2), 340–354.](https://osf.io/erp7v/files/osfstorage)
